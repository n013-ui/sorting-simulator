<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ’åºæ¨¡æ“¬å™¨</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f172a; --card: #1e293b; --card2: #273449;
  --accent: #38bdf8; --accent2: #f472b6; --gold: #fbbf24;
  --green: #4ade80; --red: #f87171; --text: #e2e8f0;
  --muted: #94a3b8; --border: #334155;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 16px; }
h1 { text-align: center; font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 4px; }
.subtitle { text-align: center; color: var(--muted); font-size: 0.9rem; margin-bottom: 12px; }

/* â”€â”€ å­¸ç”Ÿè³‡æ–™ Modal â”€â”€ */
.sm-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.72); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 16px; }
.sm-card { background: var(--card); border: 2px solid var(--accent); border-radius: 20px; padding: 32px 28px; max-width: 380px; width: 100%; }
.sm-card h2 { font-size: 1.4rem; font-weight: 900; color: var(--accent); margin-bottom: 6px; }
.sm-card p { font-size: 0.85rem; color: var(--muted); margin-bottom: 22px; line-height: 1.6; }
.sm-field { margin-bottom: 14px; }
.sm-field label { display: block; font-size: 0.82rem; font-weight: 700; color: var(--muted); margin-bottom: 5px; }
.sm-field input { width: 100%; background: var(--card2); border: 2px solid var(--border); color: var(--text); border-radius: 10px; padding: 10px 14px; font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 700; outline: none; transition: border-color 0.15s; }
.sm-field input:focus { border-color: var(--accent); }
.sm-warn { background: rgba(248,113,113,0.12); border: 1px solid var(--red); border-radius: 8px; padding: 8px 12px; font-size: 0.85rem; color: var(--red); margin-bottom: 12px; }

/* â”€â”€ å­¸ç”Ÿè³‡è¨Šåˆ— â”€â”€ */
.student-bar { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
.student-chips { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.chip { background: var(--card2); border: 1px solid var(--border); border-radius: 8px; padding: 4px 12px; font-size: 0.82rem; font-weight: 700; }
.chip .cl { color: var(--muted); font-weight: 400; margin-right: 3px; font-size: 0.75rem; }
.chip-count { border-color: var(--gold); color: var(--gold); }
.chip-best { border-color: var(--accent); color: var(--accent); font-size: 0.78rem; }

.instructions { background: var(--card); border: 2px solid var(--accent); border-radius: 14px; padding: 16px 20px; margin-bottom: 16px; }
.instructions .ititle { font-weight: 900; color: var(--accent); margin-bottom: 10px; font-size: 1rem; }
.instructions ol { padding-left: 20px; }
.instructions li { line-height: 2.2; font-size: 0.92rem; }
.instructions li b { color: var(--gold); }
.instructions .note { margin-top: 10px; padding: 8px 12px; background: var(--card2); border-radius: 8px; font-size: 0.85rem; color: var(--muted); }

.controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 16px; background: var(--card); padding: 12px; border-radius: 14px; border: 1px solid var(--border); }
.ctrl-group { display: flex; align-items: center; gap: 8px; }
.ctrl-group label { font-size: 0.85rem; color: var(--muted); font-weight: 700; }
select { background: var(--card2); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 6px 10px; font-family: 'Nunito', sans-serif; font-size: 0.9rem; cursor: pointer; }
.btn { padding: 8px 18px; border-radius: 10px; border: none; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.9rem; cursor: pointer; transition: all 0.15s; }
.btn:hover { transform: translateY(-2px); filter: brightness(1.15); }
.btn:active { transform: translateY(0); }
.btn-primary { background: var(--accent); color: #0f172a; }
.btn-danger { background: var(--red); color: #0f172a; }
.btn-success { background: var(--green); color: #0f172a; }
.btn-muted { background: var(--card2); color: var(--muted); border: 1px solid var(--border); }
.btn-sm { padding: 5px 12px; font-size: 0.78rem; border-radius: 8px; }
.btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; filter: none !important; }

.stats { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 16px; }
.stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px 20px; text-align: center; min-width: 100px; }
.stat-card .val { font-size: 1.8rem; font-weight: 900; line-height: 1; }
.stat-card .lbl { font-size: 0.75rem; color: var(--muted); font-weight: 700; margin-top: 2px; }
.val-compare { color: var(--accent); }
.val-swap { color: var(--accent2); }
.val-time { color: var(--gold); }

.message-box { background: var(--card2); border-left: 4px solid var(--accent); border-radius: 10px; padding: 10px 14px; font-size: 0.9rem; font-weight: 700; min-height: 44px; display: flex; align-items: center; margin-bottom: 16px; }

.scale-section { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
.section-title { font-size: 0.8rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px; text-align: center; }

.pans-layout { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }

.pan-zone { width: 120px; min-height: 120px; border: 3px dashed var(--border); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
.pan-zone.over { border-color: var(--accent); background: rgba(56,189,248,0.1); }
.pan-zone.filled-left { border-style: solid; border-color: var(--accent); }
.pan-zone.filled-right { border-style: solid; border-color: var(--accent2); }
.pan-empty-hint { font-size: 0.75rem; color: var(--border); text-align: center; line-height: 1.6; }
.pan-ball { width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
.pan-pos { font-size: 0.72rem; color: var(--muted); font-weight: 700; }

.scale-visual { display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; }
.scale-container { width: 90px; height: 80px; position: relative; }
.scale-pole { position: absolute; left: 50%; top: 0; transform: translateX(-50%); width: 5px; height: 44px; background: #64748b; border-radius: 3px; }
.scale-beam { position: absolute; top: 40px; left: 50%; transform: translateX(-50%) rotate(0deg); width: 76px; height: 6px; background: #64748b; border-radius: 3px; transition: transform 0.5s cubic-bezier(.34,1.56,.64,1); transform-origin: center center; }
.scale-tick { position: absolute; top: 6px; width: 2px; height: 12px; background: #64748b; border-radius: 1px; }
.scale-tick.left { left: 3px; }
.scale-tick.right { right: 3px; }
.scale-result-text { font-size: 0.85rem; font-weight: 700; text-align: center; min-height: 22px; padding: 2px 6px; }

.scale-actions { display: flex; gap: 10px; justify-content: center; }

.array-section { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
.array-hint { font-size: 0.82rem; color: var(--muted); margin-bottom: 14px; }
.balls-row { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
.ball-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.ball { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.3rem; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.4); cursor: grab; transition: all 0.2s; user-select: none; outline-offset: 4px; }
.ball:hover { transform: scale(1.12); filter: brightness(1.2); }
.ball:active { cursor: grabbing; }
.ball.dragging { opacity: 0.35; transform: scale(0.95); }
.ball.on-left { outline: 3px solid var(--accent); }
.ball.on-right { outline: 3px solid var(--accent2); }
.ball.sorted { outline: 3px solid var(--green); opacity: 0.8; cursor: default; }
.ball-idx { font-size: 0.68rem; color: var(--muted); font-weight: 700; }

.target-section { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.target-lbl { font-size: 0.8rem; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }

.log-section { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
.log-title { font-size: 0.8rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 10px; display: flex; justify-content: space-between; }
.log-list { max-height: 160px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
.log-entry { font-size: 0.82rem; padding: 6px 10px; border-radius: 8px; background: var(--card2); display: flex; align-items: center; gap: 8px; }
.tag { font-size: 0.7rem; font-weight: 800; padding: 2px 7px; border-radius: 5px; flex-shrink: 0; }
.tag-compare { background: #0ea5e9; color: #0f172a; }
.tag-swap { background: var(--accent2); color: #0f172a; }
.tag-done { background: var(--green); color: #0f172a; }

.leaderboard-section { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-top: 16px; }
.lb-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
.lb-tab { padding: 5px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--card2); color: var(--muted); font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.85rem; cursor: pointer; transition: all 0.15s; }
.lb-tab:hover { border-color: var(--accent); color: var(--accent); }
.lb-tab.active { background: var(--accent); color: #0f172a; border-color: var(--accent); }
.lb-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.lb-table th { text-align: left; padding: 6px 10px; color: var(--muted); font-weight: 700; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; }
.lb-table td { padding: 6px 10px; border-bottom: 1px solid var(--border); }
.lb-table tr:last-child td { border-bottom: none; }
.lb-rank-1 { color: var(--gold); font-weight: 900; }
.lb-rank-2 { color: #94a3b8; font-weight: 900; }
.lb-rank-3 { color: #b45309; font-weight: 900; }
.lb-me { background: rgba(56,189,248,0.08); }
.lb-empty { text-align: center; padding: 20px; color: var(--muted); font-size: 0.88rem; }

.win-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 99; }
.win-banner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: var(--card); border: 2px solid var(--green); border-radius: 20px; padding: 32px 36px; text-align: center; z-index: 100; box-shadow: 0 20px 60px rgba(0,0,0,0.8); min-width: 280px; max-width: 380px; width: 92%; }
.win-banner h2 { font-size: 2rem; color: var(--green); -webkit-text-fill-color: var(--green); margin-bottom: 10px; }
.win-stats { color: var(--muted); font-size: 0.92rem; line-height: 2.3; margin-bottom: 16px; text-align: left; }
.win-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.submit-status { font-size: 0.82rem; font-weight: 700; margin: 6px 0 12px; min-height: 20px; }
.submit-ok { color: var(--green); }
.submit-err { color: var(--red); }
.submit-pending { color: var(--gold); }

@media (max-width: 480px) {
  h1 { font-size: 1.5rem; }
  .ball { width: 46px; height: 46px; font-size: 1.1rem; }
  .pan-zone { width: 100px; }
  .win-banner { padding: 24px 18px; }
}
</style>
</head>
<body>

<!-- å­¸ç”Ÿè³‡æ–™ Modal -->
<div class="sm-overlay" id="smOverlay">
  <div class="sm-card">
    <h2>ğŸ“ å­¸ç”Ÿè³‡æ–™</h2>
    <p>è«‹å…ˆå¡«å¯«ç­ç´šã€åº§è™Ÿèˆ‡å§“åï¼Œæ‰èƒ½é–‹å§‹ç·´ç¿’ã€‚<br>æ¯æ¬¡æˆåŠŸå®Œæˆæ’åºï¼Œæˆç¸¾æ‰æœƒè¨˜éŒ„åˆ°é›²ç«¯ã€‚</p>
    <div class="sm-field">
      <label>ç­ç´š</label>
      <input type="text" id="inputClass" placeholder="ä¾‹å¦‚ï¼š303" maxlength="20" autocomplete="off">
    </div>
    <div class="sm-field">
      <label>åº§è™Ÿ</label>
      <input type="text" id="inputSeat" placeholder="ä¾‹å¦‚ï¼š12" maxlength="5" autocomplete="off">
    </div>
    <div class="sm-field">
      <label>å§“å</label>
      <input type="text" id="inputName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" maxlength="20" autocomplete="off">
    </div>
    <div class="sm-warn" id="smWarn" style="display:none">âš ï¸ è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½</div>
    <button class="btn btn-primary" style="width:100%;padding:12px;font-size:1rem;margin-top:4px" onclick="submitStudentInfo()">é–‹å§‹ç·´ç¿’ â†’</button>
  </div>
</div>

<!-- å€‹äººç´€éŒ„ Modal -->
<div class="sm-overlay" id="myRecordsOverlay" style="display:none" onclick="hideMyRecords()">
  <div class="sm-card" style="max-width:440px" onclick="event.stopPropagation()">
    <h2>ğŸ“Š æˆ‘çš„æœ€ä½³ç´€éŒ„</h2>
    <p id="myRecordsMeta" style="font-size:0.82rem;color:var(--muted);margin-bottom:16px;line-height:1.6"></p>
    <div id="myRecordsContent"></div>
    <button class="btn btn-muted" style="width:100%;padding:12px;margin-top:16px" onclick="hideMyRecords()">é—œé–‰</button>
  </div>
</div>

<h1>âš–ï¸ æ’åºæ¨¡æ“¬å™¨</h1>
<p class="subtitle">è‡ªç”±ç·´ç¿’æ’åº â€” ç”¨ä»»ä½•æ–¹å¼æŠŠçƒå¾å°æ’åˆ°å¤§ï¼</p>

<!-- å­¸ç”Ÿè³‡è¨Šåˆ— -->
<div class="student-bar" id="studentBar" style="display:none">
  <div class="student-chips">
    <span class="chip"><span class="cl">ç­ç´š</span><span id="chipClass">â€”</span></span>
    <span class="chip"><span class="cl">åº§è™Ÿ</span><span id="chipSeat">â€”</span></span>
    <span class="chip"><span class="cl">å§“å</span><span id="chipName">â€”</span></span>
    <span class="chip chip-count"><span class="cl">æˆåŠŸ</span><span id="chipCount">0</span><span class="cl"> æ¬¡</span></span>
    <span class="chip chip-best" id="chipBestWrap" style="display:none">ğŸ† <span id="chipBestLabel">æœ€ä½³</span>ï¼š<span id="chipBest">â€”</span></span>
  </div>
  <div style="display:flex;gap:6px">
    <button class="btn btn-muted btn-sm" onclick="showMyRecords()">ğŸ“Š æˆ‘çš„ç´€éŒ„</button>
    <button class="btn btn-muted btn-sm" onclick="changeStudent()">æ›äºº</button>
  </div>
</div>

<div class="instructions">
  <div class="ititle">ğŸ“‹ æ“ä½œèªªæ˜</div>
  <ol>
    <li><b>ç¬¬ä¸€æ­¥</b>ï¼šå¾ä¸‹æ–¹ã€Œç›®å‰æ’åˆ—ã€ï¼Œç”¨æ»‘é¼ æŠŠä¸€é¡†çƒ <b>æ‹–æ›³</b> åˆ°å¤©å¹³çš„ <b>å·¦æ‰˜ç›¤</b></li>
    <li><b>ç¬¬äºŒæ­¥</b>ï¼šå†æŠŠå¦ä¸€é¡†çƒæ‹–æ›³åˆ°å¤©å¹³çš„ <b>å³æ‰˜ç›¤</b></li>
    <li><b>ç¬¬ä¸‰æ­¥</b>ï¼šå¤©å¹³æœƒå‚¾æ–œ â€”â€” <b>è¼ƒä½çš„é‚£å´</b> ä»£è¡¨æ•¸å­—è¼ƒå¤§</li>
    <li><b>ç¬¬å››æ­¥</b>ï¼šè‹¥éœ€è¦äº¤æ›ï¼Œé» <b>ã€ŒğŸ”„ äº¤æ›ã€</b>ï¼›ä¸äº¤æ›å°±ç¹¼çºŒæ‹–ä¸‹ä¸€é¡†çƒ</li>
    <li><b>ç›®æ¨™</b>ï¼šè®“æ‰€æœ‰çƒå¾å·¦åˆ°å³<b>ç”±è¼•æ’åˆ°é‡</b>ï¼Œå®Œæˆæ’åºå³å‹åˆ©ï¼ğŸ‰</li>
  </ol>
  <div class="note">ğŸ’¡ çƒä¸Šåªé¡¯ç¤ºä»£è™Ÿï¼ˆAã€Bã€Câ€¦ï¼‰ï¼Œé‡é‡éœ€é å¤©å¹³æ¯”è¼ƒæ‰èƒ½çŸ¥é“ã€‚å¯ä»¥ç”¨ä»»ä½•æ’åºç­–ç•¥ï¼</div>
</div>

<div class="controls">
  <div class="ctrl-group">
    <label>çƒæ•¸ï¼š</label>
    <select id="ballCount">
      <option value="4">4 é¡†</option>
      <option value="5" selected>5 é¡†</option>
      <option value="6">6 é¡†</option>
      <option value="7">7 é¡†</option>
      <option value="8">8 é¡†</option>
    </select>
  </div>
  <button class="btn btn-primary" onclick="startNewGame()">ğŸ”€ é‡æ–°ç”¢ç”Ÿ</button>
</div>

<div class="stats">
  <div class="stat-card">
    <div class="val val-compare" id="statCompare">0</div>
    <div class="lbl">âš–ï¸ æ¯”è¼ƒæ¬¡æ•¸</div>
  </div>
  <div class="stat-card">
    <div class="val val-swap" id="statSwap">0</div>
    <div class="lbl">ğŸ”„ äº¤æ›æ¬¡æ•¸</div>
  </div>
  <div class="stat-card">
    <div class="val val-time" id="statTime">00:00</div>
    <div class="lbl">â±ï¸ ç”¨æ™‚</div>
  </div>
</div>

<div class="message-box" id="msgBox">æŠŠçƒæ‹–æ›³åˆ°å¤©å¹³çš„å·¦å³æ‰˜ç›¤ä¾†é–‹å§‹æ¯”è¼ƒï¼</div>

<div class="scale-section">
  <div class="section-title">âš–ï¸ å¤©å¹³æ¯”è¼ƒå€ â€” å°‡çƒæ‹–æ›³è‡³å·¦æ‰˜ç›¤æˆ–å³æ‰˜ç›¤</div>
  <div class="pans-layout">

    <div style="display:flex;flex-direction:column;align-items:center;gap:6px">
      <div style="font-size:0.8rem;font-weight:800;color:var(--accent)">â† å·¦æ‰˜ç›¤</div>
      <div class="pan-zone" id="panLeft"
           ondragover="onDragOverPan(event,'left')"
           ondragleave="onDragLeavePan(event,'left')"
           ondrop="onDropPan(event,'left')">
        <div id="panLeftContent"><span class="pan-empty-hint">å°‡çƒæ‹–æ›³<br>è‡³æ­¤</span></div>
      </div>
    </div>

    <div class="scale-visual">
      <div class="scale-container">
        <div class="scale-pole"></div>
        <div class="scale-beam" id="scaleBeam">
          <div class="scale-tick left"></div>
          <div class="scale-tick right"></div>
        </div>
      </div>
      <div class="scale-result-text" id="scaleResult">â€”</div>
    </div>

    <div style="display:flex;flex-direction:column;align-items:center;gap:6px">
      <div style="font-size:0.8rem;font-weight:800;color:var(--accent2)">å³æ‰˜ç›¤ â†’</div>
      <div class="pan-zone" id="panRight"
           ondragover="onDragOverPan(event,'right')"
           ondragleave="onDragLeavePan(event,'right')"
           ondrop="onDropPan(event,'right')">
        <div id="panRightContent"><span class="pan-empty-hint">å°‡çƒæ‹–æ›³<br>è‡³æ­¤</span></div>
      </div>
    </div>

  </div>
  <div class="scale-actions">
    <button class="btn btn-muted" id="clearBtn" onclick="clearPans()" disabled>âœ• æ¸…é™¤æ‰˜ç›¤</button>
    <button class="btn btn-success" id="swapBtn" onclick="doSwap()" disabled>ğŸ”„ äº¤æ›å…©çƒä½ç½®</button>
  </div>
</div>

<div class="array-section">
  <div class="section-title" style="text-align:left;margin-bottom:6px">ğŸ± ç›®å‰æ’åˆ—</div>
  <div class="array-hint">â†“ ç”¨æ»‘é¼ å°‡çƒæ‹–æ›³åˆ°ä¸Šæ–¹å¤©å¹³çš„å·¦æ‰˜ç›¤æˆ–å³æ‰˜ç›¤</div>
  <div class="balls-row" id="ballsRow"></div>
</div>

<div class="target-section">
  <span class="target-lbl">ğŸ¯ ç›®æ¨™ï¼š</span>
  <span id="targetDisplay" style="font-weight:800;font-size:1rem;letter-spacing:2px;color:var(--muted)"></span>
</div>

<div class="log-section">
  <div class="log-title">
    <span>ğŸ“‹ æ“ä½œç´€éŒ„</span>
    <span id="logCount" style="font-weight:400">0 ç­†</span>
  </div>
  <div class="log-list" id="logList"></div>
</div>

<div class="leaderboard-section">
  <div class="log-title" style="margin-bottom:10px">
    <span>ğŸ† å„çƒæ•¸å‰ååæ’è¡Œæ¦œ</span>
    <button class="btn btn-muted btn-sm" onclick="fetchLeaderboard()">ğŸ”„ æ›´æ–°</button>
  </div>
  <div class="lb-tabs" id="lbTabs">
    <button class="lb-tab" onclick="switchLbTab(4)">4 é¡†</button>
    <button class="lb-tab active" onclick="switchLbTab(5)">5 é¡†</button>
    <button class="lb-tab" onclick="switchLbTab(6)">6 é¡†</button>
    <button class="lb-tab" onclick="switchLbTab(7)">7 é¡†</button>
    <button class="lb-tab" onclick="switchLbTab(8)">8 é¡†</button>
  </div>
  <div id="lbContent"><div class="lb-empty">è¼‰å…¥ä¸­â€¦</div></div>
</div>

<div class="win-overlay" id="winOverlay" onclick="closeWin()"></div>
<div class="win-banner" id="winBanner">
  <h2>ğŸ‰ æ’åºå®Œæˆï¼</h2>
  <div class="win-stats" id="winStats"></div>
  <div class="submit-status" id="submitStatus"></div>
  <div class="win-actions">
    <button class="btn btn-success" onclick="replaySameBalls()">ğŸ” åŒçƒæ•¸å†ç·´</button>
    <button class="btn btn-primary" onclick="closeWin(); startNewGame()">ğŸ”€ æ›çƒæ•¸ç·´ç¿’</button>
    <button class="btn btn-muted" onclick="closeWin(); changeStudent()">æ›äºº</button>
  </div>
</div>

<script>
// ===== è¨­å®šï¼ˆè²¼ä¸Šä½ çš„ Google Apps Script URLï¼‰=====
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxSt1TcvSp52-WuLw8q9yEtc9tAdCkdC7oU6P9WI592Z72EUZOIkzYF003qCM4qBkcx/exec';

// ===== çƒçš„å¸¸æ•¸ =====
const COLORS = ['#f43f5e','#f97316','#eab308','#22c55e','#06b6d4','#6366f1','#a855f7','#ec4899'];
const BALL_LABELS = ['A','B','C','D','E','F','G','H'];

// ===== éŠæˆ²ç‹€æ…‹ =====
let arr = [], panL = null, panR = null;
let labelOf = {};
let compareCount = 0, swapCount = 0;
let startTime = null, timerInterval = null, gameDone = false;

// ===== å­¸ç”Ÿç‹€æ…‹ =====
let currentStudent = null; // { cls, seat, name }

// ===== æ’è¡Œæ¦œç‹€æ…‹ =====
var currentBallCount = 5;
var lbData = [];
var lbActiveBalls = 5;

// ===== å€‹äººç´€éŒ„ï¼ˆlocalStorageï¼‰=====
function getRecordKey(s) {
  return 'sortRecord_' + s.cls + '_' + s.seat + '_' + s.name;
}
function getStudentRecord(s) {
  return JSON.parse(localStorage.getItem(getRecordKey(s)) || 'null');
  // æ ¼å¼: { count: N, best: { compare, sec, elapsed } }
}
function updateStudentRecord(s, balls, compare, sec, elapsed) {
  const key = getRecordKey(s);
  const rec = getStudentRecord(s) || { count: 0, bests: {} };
  rec.count = (rec.count || 0) + 1;
  if (!rec.bests) rec.bests = {}; // ç›¸å®¹èˆŠæ ¼å¼
  const ex = rec.bests[balls];
  let isNewBest = false;
  // æœ€ä½³åˆ¤å®šï¼šæ¯”è¼ƒæ¬¡æ•¸å°‘å„ªå…ˆï¼Œç›¸åŒæ™‚ç§’æ•¸å°‘è€…å‹
  if (!ex
      || compare < ex.compare
      || (compare === ex.compare && sec < ex.sec)) {
    rec.bests[balls] = { compare, sec, elapsed };
    isNewBest = true;
  }
  localStorage.setItem(key, JSON.stringify(rec));
  return { count: rec.count, isNewBest, best: rec.bests[balls] };
}

function refreshStudentBar() {
  if (!currentStudent) return;
  document.getElementById('chipClass').textContent = currentStudent.cls;
  document.getElementById('chipSeat').textContent = currentStudent.seat + ' è™Ÿ';
  document.getElementById('chipName').textContent = currentStudent.name;
  const rec = getStudentRecord(currentStudent);
  document.getElementById('chipCount').textContent = rec ? (rec.count || 0) : 0;
  const bestWrap = document.getElementById('chipBestWrap');
  const currentBest = rec && rec.bests && rec.bests[currentBallCount];
  if (currentBest) {
    document.getElementById('chipBestLabel').textContent = currentBallCount + 'é¡†æœ€ä½³';
    document.getElementById('chipBest').textContent =
      'æ¯”è¼ƒ ' + currentBest.compare + ' æ¬¡ãƒ»' + currentBest.elapsed;
    bestWrap.style.display = '';
  } else {
    bestWrap.style.display = 'none';
  }
}

// ===== å­¸ç”Ÿ Modal =====
function showStudentModal() {
  document.getElementById('smOverlay').style.display = 'flex';
  document.getElementById('smWarn').style.display = 'none';
  document.getElementById('inputClass').value = '';
  document.getElementById('inputSeat').value = '';
  document.getElementById('inputName').value = '';
  setTimeout(() => document.getElementById('inputClass').focus(), 100);
}

function submitStudentInfo() {
  const cls  = document.getElementById('inputClass').value.trim();
  const seat = document.getElementById('inputSeat').value.trim();
  const name = document.getElementById('inputName').value.trim();
  if (!cls || !seat || !name) {
    document.getElementById('smWarn').style.display = 'block';
    return;
  }
  currentStudent = { cls, seat, name };
  document.getElementById('smOverlay').style.display = 'none';
  document.getElementById('studentBar').style.display = 'flex';
  refreshStudentBar();
  startNewGame();
}

function changeStudent() {
  currentStudent = null;
  document.getElementById('studentBar').style.display = 'none';
  showStudentModal();
}

// Enter éµé€å‡º modal
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && document.getElementById('smOverlay').style.display !== 'none') {
    submitStudentInfo();
  }
});

// ===== è¨ˆæ™‚å™¨ =====
function startTimer() {
  startTime = Date.now();
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(function() {
    var e = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('statTime').textContent =
      String(Math.floor(e/60)).padStart(2,'0') + ':' + String(e%60).padStart(2,'0');
  }, 500);
}
function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
function elapsedStr() {
  if (!startTime) return '00:00';
  var e = Math.floor((Date.now() - startTime) / 1000);
  return String(Math.floor(e/60)).padStart(2,'0') + ':' + String(e%60).padStart(2,'0');
}
function elapsedSec() {
  if (!startTime) return 0;
  return Math.floor((Date.now() - startTime) / 1000);
}

// ===== å·¥å…· =====
function shuffle(a) {
  for (var i = a.length-1; i > 0; i--) {
    var j = Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t;
  }
  return a;
}
function isSorted() { for (var i=0;i<arr.length-1;i++) if (arr[i]>arr[i+1]) return false; return true; }

// ===== éŠæˆ²åˆå§‹åŒ– =====
function initGame() {
  showStudentModal(); // ä¸€å®šè¦å…ˆè¼¸å…¥å­¸ç”Ÿè³‡æ–™
}

function startNewGame() {
  stopTimer();
  var n = parseInt(document.getElementById('ballCount').value);
  currentBallCount = n;
  refreshStudentBar();
  switchLbTab(n);
  arr = shuffle(Array.from({length:n},function(_,i){return i+1;}));
  while (isSorted()) arr = shuffle(arr.slice());
  var shuffledLabels = shuffle(BALL_LABELS.slice(0, n));
  labelOf = {};
  for (var w = 1; w <= n; w++) labelOf[w] = shuffledLabels[w-1];
  compareCount = 0; swapCount = 0; gameDone = false; panL = null; panR = null;
  clearLog(); updateStats(); renderBalls(); resetScale();
  setMsg('æŠŠçƒæ‹–æ›³åˆ°å¤©å¹³çš„å·¦å³æ‰˜ç›¤ä¾†é–‹å§‹æ¯”è¼ƒï¼');
  document.getElementById('targetDisplay').textContent = 'ï¼Ÿ ï¼œ ï¼Ÿ ï¼œ ï¼Ÿï¼ˆç”±è¼•åˆ°é‡æ’åˆ—ï¼‰';
  document.getElementById('winBanner').style.display = 'none';
  document.getElementById('winOverlay').style.display = 'none';
  document.getElementById('submitStatus').textContent = '';
  startTimer();
}

// ===== æ¸²æŸ“çƒ =====
function renderBalls() {
  var row = document.getElementById('ballsRow');
  row.innerHTML = '';
  arr.forEach(function(val, idx) {
    var item = document.createElement('div'); item.className = 'ball-item';
    var ball = document.createElement('div'); ball.className = 'ball';
    ball.style.background = COLORS[(val-1)%COLORS.length]; ball.textContent = labelOf[val];
    if (!gameDone) {
      ball.draggable = true; ball.dataset.index = idx;
      ball.addEventListener('dragstart', (function(i){ return function(e){ onDragStart(e,i); }; })(idx));
      ball.addEventListener('dragend', onDragEnd);
      if (panL && panL.index === idx) ball.classList.add('on-left');
      if (panR && panR.index === idx) ball.classList.add('on-right');
    } else { ball.classList.add('sorted'); }
    var lbl = document.createElement('div'); lbl.className = 'ball-idx';
    lbl.textContent = 'ä½ç½® '+(idx+1);
    item.appendChild(ball); item.appendChild(lbl); row.appendChild(item);
  });
}

// ===== æ‹–æ›³ =====
function onDragStart(e, index) {
  e.dataTransfer.setData('text/plain', String(index)); e.dataTransfer.effectAllowed = 'copy';
  setTimeout(function(){ document.querySelectorAll('.ball').forEach(function(b){ if (parseInt(b.dataset.index)===index) b.classList.add('dragging'); }); }, 0);
}
function onDragEnd() { document.querySelectorAll('.ball').forEach(function(b){ b.classList.remove('dragging'); }); }
function onDragOverPan(e, side) { e.preventDefault(); e.dataTransfer.dropEffect='copy'; document.getElementById(side==='left'?'panLeft':'panRight').classList.add('over'); }
function onDragLeavePan(e, side) { document.getElementById(side==='left'?'panLeft':'panRight').classList.remove('over'); }

function onDropPan(e, side) {
  e.preventDefault();
  document.getElementById(side==='left'?'panLeft':'panRight').classList.remove('over');
  var index = parseInt(e.dataTransfer.getData('text/plain'));
  if (isNaN(index)||index<0||index>=arr.length) return;
  var value = arr[index];
  if (side==='left'  && panR && panR.index===index) { setMsg('âš ï¸ é€™é¡†çƒå·²åœ¨å³æ‰˜ç›¤ï¼è«‹é¸å¦ä¸€é¡†ã€‚'); return; }
  if (side==='right' && panL && panL.index===index) { setMsg('âš ï¸ é€™é¡†çƒå·²åœ¨å·¦æ‰˜ç›¤ï¼è«‹é¸å¦ä¸€é¡†ã€‚'); return; }
  if (side==='left') panL={index:index,value:value}; else panR={index:index,value:value};
  renderPan('left', panL); renderPan('right', panR); renderBalls();
  document.getElementById('clearBtn').disabled = false;
  if (panL && panR) {
    compareCount++; updateStats(); updateScale();
    addLog('compare','æ¯”è¼ƒ çƒ'+labelOf[panL.value]+'ï¼ˆä½ç½®'+(panL.index+1)+'ï¼‰å’Œ çƒ'+labelOf[panR.value]+'ï¼ˆä½ç½®'+(panR.index+1)+'ï¼‰');
    document.getElementById('swapBtn').disabled=false;
  }
}

function renderPan(side, state) {
  var panEl  = document.getElementById(side==='left'?'panLeft':'panRight');
  var contEl = document.getElementById(side==='left'?'panLeftContent':'panRightContent');
  panEl.classList.remove('filled-left','filled-right');
  if (state) {
    panEl.classList.add(side==='left'?'filled-left':'filled-right');
    var ball = document.createElement('div'); ball.className='pan-ball';
    ball.style.background=COLORS[(state.value-1)%COLORS.length]; ball.textContent=labelOf[state.value];
    var pos = document.createElement('div'); pos.className='pan-pos'; pos.textContent='ä½ç½® '+(state.index+1);
    contEl.innerHTML=''; contEl.appendChild(ball); contEl.appendChild(pos);
  } else { contEl.innerHTML='<span class="pan-empty-hint">å°‡çƒæ‹–æ›³<br>è‡³æ­¤</span>'; }
}

function updateScale() {
  if (!panL||!panR) return;
  var l=panL.value, r=panR.value;
  var beam=document.getElementById('scaleBeam'), res=document.getElementById('scaleResult');
  var lLabel = labelOf[l], rLabel = labelOf[r];
  if (l>r) {
    beam.style.transform='translateX(-50%) rotate(-15deg)';
    res.innerHTML='<span style="color:var(--accent2)">çƒ '+lLabel+' è¼ƒé‡ â†™ï¼Œçƒ '+rLabel+' è¼ƒè¼•</span>';
    setMsg('âš–ï¸ çƒ '+lLabel+'ï¼ˆä½ç½®'+(panL.index+1)+'ï¼‰æ¯” çƒ '+rLabel+'ï¼ˆä½ç½®'+(panR.index+1)+'ï¼‰é‡ â€” éœ€è¦äº¤æ›å—ï¼Ÿ');
  } else if (l<r) {
    beam.style.transform='translateX(-50%) rotate(15deg)';
    res.innerHTML='<span style="color:var(--green)">çƒ '+lLabel+' è¼ƒè¼•ï¼Œçƒ '+rLabel+' è¼ƒé‡ â†˜</span>';
    setMsg('âš–ï¸ çƒ '+lLabel+'ï¼ˆä½ç½®'+(panL.index+1)+'ï¼‰æ¯” çƒ '+rLabel+'ï¼ˆä½ç½®'+(panR.index+1)+'ï¼‰è¼• â€” é †åºæ­£ç¢ºï¼Œä¸éœ€äº¤æ›ï¼');
  } else {
    beam.style.transform='translateX(-50%) rotate(0deg)';
    res.innerHTML='<span style="color:var(--muted)">å…©çƒä¸€æ¨£é‡ï¼Œå¤©å¹³å¹³è¡¡</span>';
    setMsg('âš–ï¸ å…©çƒä¸€æ¨£é‡ï¼Œä¸éœ€è¦äº¤æ›ã€‚');
  }
}

function resetScale() {
  document.getElementById('scaleBeam').style.transform='translateX(-50%) rotate(0deg)';
  document.getElementById('scaleResult').textContent='â€”';
  renderPan('left',null); renderPan('right',null);
  document.getElementById('swapBtn').disabled=true; document.getElementById('clearBtn').disabled=true;
}

function doSwap() {
  if (!panL||!panR) return;
  var li=panL.index,ri=panR.index,lv=panL.value,rv=panR.value;
  var tmp=arr[li]; arr[li]=arr[ri]; arr[ri]=tmp;
  swapCount++; updateStats();
  addLog('swap','äº¤æ› çƒ'+labelOf[lv]+'ï¼ˆä½ç½®'+(li+1)+'ï¼‰â†” çƒ'+labelOf[rv]+'ï¼ˆä½ç½®'+(ri+1)+'ï¼‰');
  setMsg('ğŸ”„ å·²äº¤æ›ï¼çƒ '+labelOf[lv]+' ç§»åˆ°ä½ç½®'+(ri+1)+'ï¼Œçƒ '+labelOf[rv]+' ç§»åˆ°ä½ç½®'+(li+1));
  panL=null; panR=null; resetScale(); renderBalls(); checkWin();
}

function clearPans() { panL=null; panR=null; resetScale(); renderBalls(); setMsg('æ‰˜ç›¤å·²æ¸…é™¤ï¼Œç¹¼çºŒæ‹–æ›³çƒä¾†æ¯”è¼ƒã€‚'); }

// ===== å‹åˆ©åˆ¤å®š =====
function checkWin() {
  if (!isSorted()) return;
  gameDone = true; stopTimer();
  var t = elapsedStr();
  var sec = elapsedSec();
  var n = parseInt(document.getElementById('ballCount').value);

  // æ›´æ–°å€‹äººæœ€ä½³ç´€éŒ„ï¼ˆä¾çƒæ•¸åˆ†é–‹è¨˜éŒ„ï¼‰
  var result = updateStudentRecord(currentStudent, n, compareCount, sec, t);
  var count = result.count, isNewBest = result.isNewBest, best = result.best;
  refreshStudentBar();

  // ä¸Šå‚³åˆ° Google Sheetsï¼ˆéåŒæ­¥ï¼Œä¸é˜»å¡ï¼‰
  submitToSheets(currentStudent, n, compareCount, swapCount, sec, t, count, isNewBest, best);

  // æ“ä½œç´€éŒ„
  var order = arr.map(function(w){ return 'çƒ'+labelOf[w]; }).join('ï¼œ');
  addLog('done','æ’åºå®Œæˆï¼'+order+'ï¼Œæ¯”è¼ƒ '+compareCount+' æ¬¡ï¼Œäº¤æ› '+swapCount+' æ¬¡ï¼Œç”¨æ™‚ '+t);
  setMsg('ğŸ‰ æ’åºå®Œæˆï¼æ¯”è¼ƒ '+compareCount+' æ¬¡ï¼Œäº¤æ› '+swapCount+' æ¬¡ï¼Œç”¨æ™‚ '+t);
  renderBalls();

  // å‹åˆ© Banner
  var revealOrder = arr.map(function(w){ return 'çƒ'+labelOf[w]; }).join(' ï¼œ ');
  var html = '';
  html += 'ğŸ‘¤ ' + currentStudent.cls + '&nbsp;' + currentStudent.seat + 'è™Ÿ&nbsp;' + currentStudent.name + '<br>';
  html += 'âš–ï¸ æ¯”è¼ƒæ¬¡æ•¸ï¼š<b>' + compareCount + '</b> æ¬¡ã€€ğŸ”„ äº¤æ›æ¬¡æ•¸ï¼š<b>' + swapCount + '</b> æ¬¡<br>';
  html += 'â±ï¸ ç”¨æ™‚ï¼š<b>' + t + '</b><br>';
  html += 'ğŸ¯ ç¬¬ <b>' + count + '</b> æ¬¡æˆåŠŸå®Œæˆï¼<br>';
  if (isNewBest) {
    html += '<span style="color:var(--gold);font-size:1.05rem;font-weight:900">ğŸ† æ–°æœ€ä½³ç´€éŒ„ï¼</span><br>';
  } else {
    html += '<span style="color:var(--accent);font-size:0.88rem">å€‹äººæœ€ä½³ï¼šæ¯”è¼ƒ '+best.compare+' æ¬¡ãƒ»'+best.elapsed+'</span><br>';
  }
  html += '<span style="color:var(--green);font-size:0.82rem">æ­£ç¢ºæ’åˆ—ï¼š'+revealOrder+'</span>';
  document.getElementById('winStats').innerHTML = html;
  document.getElementById('winBanner').style.display = 'block';
  document.getElementById('winOverlay').style.display = 'block';
  // æˆåŠŸå¾Œæ›´æ–°æ’è¡Œæ¦œï¼ˆç¨ä½œå»¶é²ç­‰ Apps Script è™•ç†å®Œç•¢ï¼‰
  setTimeout(fetchLeaderboard, 2000);
}

function closeWin() {
  document.getElementById('winBanner').style.display='none';
  document.getElementById('winOverlay').style.display='none';
}

// ===== Google Sheets ä¸Šå‚³ =====
function submitToSheets(s, balls, compare, swap, sec, elapsed, count, isNewBest, best) {
  var statusEl = document.getElementById('submitStatus');
  if (!SHEET_URL) return;
  statusEl.className = 'submit-status submit-pending';
  statusEl.textContent = 'â³ ä¸Šå‚³æˆç¸¾ä¸­â€¦';
  fetch(SHEET_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: 'sorting',
      cls: s.cls, seat: s.seat, name: s.name,
      balls: balls, compare: compare, swap: swap,
      sec: sec, elapsed: elapsed,
      count: count, isNewBest: isNewBest ? 'æ˜¯' : 'å¦',
      bestCompare: best.compare, bestSec: best.sec, bestElapsed: best.elapsed
    })
  }).then(function() {
    statusEl.className = 'submit-status submit-ok';
    statusEl.textContent = 'âœ… æˆç¸¾å·²é€å‡º';
  }).catch(function() {
    statusEl.className = 'submit-status submit-err';
    statusEl.textContent = 'âš ï¸ ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š';
  });
}

// ===== çµ±è¨ˆèˆ‡è¨Šæ¯ =====
function updateStats() {
  document.getElementById('statCompare').textContent = compareCount;
  document.getElementById('statSwap').textContent = swapCount;
}
function setMsg(text) { document.getElementById('msgBox').innerHTML = text; }

function addLog(type, msg) {
  var list = document.getElementById('logList');
  var entry = document.createElement('div'); entry.className = 'log-entry';
  var tag = document.createElement('span'); tag.className = 'tag';
  if (type==='compare'){ tag.classList.add('tag-compare'); tag.textContent='æ¯”è¼ƒ'; }
  else if (type==='swap'){ tag.classList.add('tag-swap'); tag.textContent='äº¤æ›'; }
  else { tag.classList.add('tag-done'); tag.textContent='å®Œæˆ'; }
  entry.appendChild(tag); entry.appendChild(document.createTextNode(' '+msg));
  list.appendChild(entry); list.scrollTop = list.scrollHeight;
  document.getElementById('logCount').textContent = list.children.length + ' ç­†';
}
function clearLog() { document.getElementById('logList').innerHTML=''; document.getElementById('logCount').textContent='0 ç­†'; }

// ===== åŒçƒæ•¸å†ç·´ =====
function replaySameBalls() {
  document.getElementById('ballCount').value = String(currentBallCount);
  closeWin();
  startNewGame();
}

// ===== é›²ç«¯æ’è¡Œæ¦œ =====
function fetchLeaderboard() {
  if (!SHEET_URL) return;
  var contentEl = document.getElementById('lbContent');
  contentEl.innerHTML = '<div class="lb-empty">è¼‰å…¥ä¸­â€¦</div>';
  fetch(SHEET_URL + '?action=leaderboard')
    .then(function(res) { return res.json(); })
    .then(function(json) {
      if (json.ok) {
        lbData = json.data;
        renderLeaderboard(lbActiveBalls);
      } else {
        contentEl.innerHTML = '<div class="lb-empty">âš ï¸ è¼‰å…¥å¤±æ•—</div>';
      }
    })
    .catch(function() {
      contentEl.innerHTML = '<div class="lb-empty">âš ï¸ ç„¡æ³•é€£ç·šï¼Œè«‹ç¨å¾Œå†è©¦</div>';
    });
}

function switchLbTab(balls) {
  lbActiveBalls = balls;
  var tabs = document.getElementById('lbTabs').querySelectorAll('.lb-tab');
  var ballCounts = [4, 5, 6, 7, 8];
  tabs.forEach(function(tab, i) {
    if (ballCounts[i] === balls) tab.classList.add('active');
    else tab.classList.remove('active');
  });
  renderLeaderboard(balls);
}

function secToElapsed(sec) {
  var s = Number(sec);
  var m = Math.floor(s / 60);
  return String(m).padStart(2, '0') + ':' + String(s % 60).padStart(2, '0');
}

function renderLeaderboard(balls) {
  var contentEl = document.getElementById('lbContent');
  var rows = lbData.filter(function(r) { return Number(r.balls) === balls; });
  rows.sort(function(a, b) { return Number(a.rank) - Number(b.rank); });
  // å»é‡ï¼šåŒçƒæ•¸ä¸‹æ¯å€‹æ’ååªä¿ç•™ç¬¬ä¸€ç­†ï¼ˆé˜²æ­¢ä¸¦ç™¼å¯«å…¥é€ æˆçš„é‡è¤‡åˆ—ï¼‰
  var seenRanks = {};
  rows = rows.filter(function(r) {
    var rank = Number(r.rank);
    if (seenRanks[rank]) return false;
    seenRanks[rank] = true;
    return true;
  });
  if (rows.length === 0) {
    contentEl.innerHTML = '<div class="lb-empty">ç›®å‰é‚„æ²’æœ‰ ' + balls + ' é¡†çƒçš„ç´€éŒ„ â€” ä¾†çˆ­ç¬¬ä¸€åå§ï¼</div>';
    return;
  }
  var medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
  var myName = currentStudent ? currentStudent.name : null;
  var myCls  = currentStudent ? currentStudent.cls  : null;
  var mySeat = currentStudent ? currentStudent.seat  : null;
  var html = '<table class="lb-table"><thead><tr><th>æ’å</th><th>ç­ç´š</th><th>åº§è™Ÿ</th><th>å§“å</th><th>æ¯”è¼ƒæ¬¡æ•¸</th><th>ç”¨æ™‚</th></tr></thead><tbody>';
  rows.forEach(function(r) {
    var rank = Number(r.rank);
    var isMe = myName && String(r.name) === myName && String(r.cls) === myCls && String(r.seat) === mySeat;
    var rankClass = rank === 1 ? 'lb-rank-1' : rank === 2 ? 'lb-rank-2' : rank === 3 ? 'lb-rank-3' : '';
    var rowClass = isMe ? ' class="lb-me"' : '';
    var medal = medals[rank-1] || '';
    html += '<tr' + rowClass + '>';
    html += '<td class="' + rankClass + '">' + medal + ' ' + rank + '</td>';
    html += '<td>' + r.cls + '</td>';
    html += '<td>' + r.seat + '</td>';
    html += '<td>' + r.name + (isMe ? ' ğŸ‘ˆ' : '') + '</td>';
    html += '<td>' + r.compare + '</td>';
    html += '<td>' + secToElapsed(r.sec) + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table>';
  contentEl.innerHTML = html;
}

// ===== å€‹äººç´€éŒ„æŸ¥è©¢ =====
function showMyRecords() {
  document.getElementById('myRecordsOverlay').style.display = 'flex';
  if (!currentStudent) return;
  var rec = getStudentRecord(currentStudent);
  document.getElementById('myRecordsMeta').textContent =
    currentStudent.cls + 'ã€€' + currentStudent.seat + ' è™Ÿã€€' + currentStudent.name +
    'ã€€ã€€å…±å®Œæˆ ' + (rec ? (rec.count || 0) : 0) + ' æ¬¡æ’åº';
  var contentEl = document.getElementById('myRecordsContent');
  var bests = rec && rec.bests ? rec.bests : {};
  var hasBests = [4,5,6,7,8].some(function(b){ return !!bests[b]; });
  if (!hasBests) {
    contentEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">é‚„æ²’æœ‰ä»»ä½•å®Œæˆç´€éŒ„ï¼Œå¿«å»æŒ‘æˆ°çœ‹çœ‹ï¼</div>';
    return;
  }
  var html = '<table class="lb-table"><thead><tr><th>çƒæ•¸</th><th>æœ€ä½³æ¯”è¼ƒæ¬¡æ•¸</th><th>æœ€ä½³ç”¨æ™‚</th></tr></thead><tbody>';
  [4,5,6,7,8].forEach(function(b) {
    var best = bests[b];
    if (!best) return;
    var isCurrent = (b === currentBallCount);
    html += '<tr' + (isCurrent ? ' style="background:rgba(56,189,248,0.1)"' : '') + '>';
    html += '<td style="font-weight:900;color:var(--accent)">' + b + ' é¡†' + (isCurrent ? 'ã€€â—€ ç›®å‰' : '') + '</td>';
    html += '<td>' + best.compare + ' æ¬¡</td>';
    html += '<td>' + best.elapsed + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table>';
  contentEl.innerHTML = html;
}

function hideMyRecords() {
  document.getElementById('myRecordsOverlay').style.display = 'none';
}

// åˆ‡æ›çƒæ•¸æ™‚åŒæ­¥æ’è¡Œæ¦œ tab å’Œå€‹äººæœ€ä½³é¡¯ç¤º
document.getElementById('ballCount').addEventListener('change', function() {
  currentBallCount = parseInt(this.value);
  refreshStudentBar();
  switchLbTab(currentBallCount);
});

// ===== å•Ÿå‹• =====
initGame(); // é¡¯ç¤ºå­¸ç”Ÿè³‡æ–™ Modal
setTimeout(fetchLeaderboard, 1500);
</script>
</body>
</html>
